on: push
name: CI
jobs:
  phpunit:
    runs-on: ubuntu-latest
    container:
      image: kirschbaumdevelopment/laravel-test-runner:8.1

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test
        ports:
          - 33306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - uses: actions/checkout@v1
      with:
        fetch-depth: 1

    - name: Install additional PHP extensions
      run: apt-get install -y php8.1-bz2 php8.1-soap

    - name: Cache composer dependencies
      uses: actions/cache@v1
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}

    - name: Install dependencies
      run: |
        php --version
        composer config "http-basic.nova.laravel.com" "${{ secrets.NOVA_USERNAME }}" "${{ secrets.NOVA_PASSWORD }}"
        composer install -n --prefer-dist

    - name: Boot Laravel application
      run: |
        cp .env.ci .env
        php artisan key:generate
        php artisan --version

    - name: Migrate database
      run: |
        mysql --version
        php artisan migrate:fresh --seed

    - name: Run Testsuite
      run: vendor/bin/phpunit tests/
